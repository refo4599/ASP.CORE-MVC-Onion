@model IEnumerable<Restaurant.WebUI.Controllers.UserWithRoleViewModel>
@{
    ViewData["Title"] = "Manage Users";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    
    body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(270deg, #1e3c72, #2a5298, #4b6cb7, #182848);
        background-size: 800% 800%;
        animation: gradientMove 12s ease infinite;
        color: white;
    }

    @@keyframes gradientMove {
        0%

    {
        background-position: 0% 50%;
    }

    50% {
        background-position: 100% 50%;
    }

    100% {
        background-position: 0% 50%;
    }

    }

    .container {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    h2 {
        color: #fff !important;
        text-align: center;
        font-weight: bold;
        margin-bottom: 25px;
    }

    table {
        background-color: rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        overflow: hidden;
    }

    thead tr {
        background-color: rgba(0, 0, 0, 0.6);
        color: #fff;
    }

    tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.08);
        transition: 0.3s;
    }

    select {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

        select option {
            color: black;
        }

    .btn-danger {
        background-color: #ff4d4d;
        border: none;
        transition: 0.3s;
    }

        .btn-danger:hover {
            background-color: #ff1a1a;
        }

    .text-success {
        color: #00ffcc !important;
    }
</style>

<div class="container py-4">
    <h2>👥 Users</h2>

    <table class="table table-striped table-bordered align-middle text-center text-white">
        <thead>
            <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var vm in Model)
            {
                <tr data-user-id="@vm.User.Id">
                    <td>@(vm.User.FullName ?? "—")</td>
                    <td>@vm.User.Email</td>
                    <td>
                        <select class="form-select form-select-sm role-dropdown" style="width:auto;">
                            @{
                                var roles = new[] { "Admin", "Staff", "User" };
                            }
                            @foreach (var role in roles)
                            {
                                <option value="@role" selected="@(role == vm.Role ? "selected" : null)">@role</option>
                            }
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-user-btn">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                        <span class="text-success role-message"></span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        
        document.querySelectorAll('.role-dropdown').forEach(drop => {
            drop.addEventListener('change', async (e) => {
                const select = e.target;
                const row = select.closest('tr');
                const userId = row.dataset.userId;
                const newRole = select.value;
                const messageSpan = row.querySelector('.role-message');

                try {
                    const res = await fetch('/AdminUser/ChangeRole', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ UserId: userId, NewRole: newRole })
                    });

                    const data = await res.json();
                    messageSpan.textContent = data.message;
                    messageSpan.className = data.success ? 'text-success' : 'text-danger';
                } catch (err) {
                    messageSpan.textContent = 'Error changing role.';
                    messageSpan.className = 'text-danger';
                }
            });
        });

      
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const row = e.target.closest('tr');
                const userId = row.dataset.userId;
                const confirmDelete = confirm('Are you sure you want to delete this user?');

                if (!confirmDelete) return;

                try {
                    const res = await fetch('/AdminUser/DeleteUser', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ id: userId })
                    });

                    const data = await res.json();

                    if (data.success) {
                        alert(data.message);
                        row.remove();
                    } else {
                        alert(data.message);
                    }
                } catch {
                    alert('Error deleting user.');
                }
            });
        });
    </script>
}
