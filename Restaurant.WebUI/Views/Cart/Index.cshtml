@model List<Restaurant.Application.ViewModels.CartItemVM>
@{
    ViewData["Title"] = "Your Cart";
    Layout = "_UserLayout";

    var now = DateTime.Now.TimeOfDay;
    var happyHourStart = new TimeSpan(9, 0, 0);
    var happyHourEnd = new TimeSpan(23, 0, 0);
    var discountRate = 0.20m; // 20%
    bool isHappyHour = now >= happyHourStart && now <= happyHourEnd;
}

<style>
    body {
        background: url('/images/elegant-bg.jpg') center/cover fixed;
        backdrop-filter: blur(6px);
    }

    .cart-container {
        background-color: rgba(255, 255, 255, 0.85);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .cart-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
    }

        .cart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .cart-card img {
            width: 75px;
            height: 75px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

    .quantity-btn {
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .quantity-display {
        width: 40px;
        text-align: center;
        font-weight: 600;
        color: #333;
    }

    .discounted-price {
        color: #198754;
        font-weight: 700;
        font-size: 1rem;
    }

    .text-decoration-line-through {
        text-decoration: line-through;
        color: #999;
        font-size: 0.9rem;
    }

    .badge.bg-danger {
        font-size: 0.75rem;
        padding: 0.35em 0.6em;
        border-radius: 0.4rem;
    }

    .cart-title {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        font-weight: bold;
        color: #222;
        letter-spacing: 1px;
        text-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .divider {
        width: 80px;
        height: 3px;
        background-color: #198754;
        border-radius: 2px;
        margin: 10px auto 30px;
    }

    .form-select, .form-control {
        border-radius: 8px;
    }

    .btn-success {
        background-color: #198754;
        border: none;
        transition: all 0.3s;
    }

        .btn-success:hover {
            background-color: #157347;
            transform: translateY(-2px);
        }

    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }
</style>

<div class="container my-5">
    <div class="text-center mb-5">
        <h2 class="cart-title">🛒 Your Shopping Cart</h2>
        <div class="divider"></div>
    </div>

    <div class="cart-container">
        @if (!Model.Any())
        {
            <div class="alert alert-warning text-center shadow-sm fs-5">
                سلتك فارغة حالياً 😔
                <br />
                <a href="/Menu/Index" class="btn btn-outline-success mt-3">ابدأ التسوق الآن</a>
            </div>
        }
        else
        {
            <div class="row justify-content-center">
                @foreach (var item in Model)
                {
                    decimal finalPrice = isHappyHour ? Math.Round(item.Price * (1 - discountRate), 2) : item.Price;

                    <div class="col-md-6 mb-3">
                        <div class="cart-card" data-id="@item.ProductId">
                            <img src="@item.ImageUrl" alt="@item.Name" />
                            <div class="ms-3 flex-grow-1">
                                <h6 class="mb-1 fw-bold text-dark">@item.Name</h6>

                                <div class="d-flex align-items-center mb-2">
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn decrease-btn">−</button>
                                    <span class="quantity-display">@item.Quantity</span>
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn increase-btn">+</button>
                                </div>

                                @if (finalPrice < item.Price)
                                {
                                    <div class="d-flex flex-column gap-1">
                                        <span class="text-decoration-line-through">
                                            @(item.Price.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("ar-EG")))
                                        </span>
                                        <span class="discounted-price" data-price="@finalPrice">
                                            @(finalPrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("ar-EG")))
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <p class="mb-0 fw-bold text-success" data-price="@finalPrice">
                                        @(finalPrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("ar-EG")))
                                    </p>
                                }
                            </div>

                            <button class="btn btn-sm btn-outline-danger ms-3 btn-remove">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>

            <div class="row justify-content-center mt-4">
                <div class="col-md-6 text-end">
                    @{
                        decimal total = Model.Sum(item => (isHappyHour ? Math.Round(item.Price * (1 - discountRate), 2) : item.Price) * item.Quantity);
                    }
                    <h5 class="fw-bold">
                        السعر النهائي:
                        <span id="cart-total" class="text-success">
                            @(total.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("ar-EG")))
                        </span>
                    </h5>

                    <div class="mt-4 text-start">
                        <label class="fw-bold mb-2">اختر نوع الطلب:</label>
                        <select id="orderType" class="form-select mb-3" style="max-width: 300px; display:inline-block;">
                            <option value="">-- اختر نوع الطلب --</option>
                            <option value="Delivery">Delivery 🚚</option>
                            <option value="TakeAway">   TakeAway 🥡</option>
                            <option value="DineIn">أكل داخل المطعم 🍽️</option>
                        </select>
                    </div>

                    <div id="deliveryFields" style="display:none; max-width:400px;">
                        <div class="mb-2">
                            <label class="fw-bold">العنوان:</label>
                            <input type="text" id="deliveryAddress" class="form-control" placeholder="اكتب عنوان التوصيل">
                        </div>
                        <div class="mb-2">
                            <label class="fw-bold">رقم الهاتف:</label>
                            <input type="text" id="phoneNumber" class="form-control" placeholder="اكتب رقم الهاتف">
                        </div>
                    </div>

                    <div class="mt-3">
                        <a href="/Menu/Index" class="btn btn-outline-primary px-4 me-2 rounded-pill shadow-sm">
                            <i class="bi bi-arrow-left"></i> متابعة التسوق
                        </a>
                        <button id="makeOrder" class="btn btn-success px-4 rounded-pill shadow">
                            <i class="bi bi-bag-check"></i> تأكيد الطلب
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.increase-btn').forEach(btn => {
            btn.addEventListener('click', () => changeQuantity(btn, 1));
        });
        document.querySelectorAll('.decrease-btn').forEach(btn => {
            btn.addEventListener('click', () => changeQuantity(btn, -1));
        });
        document.querySelectorAll('.btn-remove').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const card = e.target.closest('.cart-card');
                const productId = card.dataset.id;
                await fetch('/Cart/RemoveFromCart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `productId=${productId}`
                });
                card.remove();
                updateTotal();
            });
        });

        function changeQuantity(btn, delta) {
            const card = btn.closest('.cart-card');
            const id = card.dataset.id;
            const quantityEl = card.querySelector('.quantity-display');
            let val = parseInt(quantityEl.textContent) + delta;
            if (val < 1) val = 1;
            quantityEl.textContent = val;

            fetch('/Cart/UpdateQuantity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `productId=${id}&quantity=${val}`
            });

            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('.cart-card').forEach(c => {
                const q = parseInt(c.querySelector('.quantity-display').textContent);
                const p = parseFloat(c.querySelector('[data-price]').dataset.price);
                total += q * p;
            });
            document.getElementById('cart-total').textContent =
                new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(total);
        }

        document.getElementById("orderType").addEventListener("change", function () {
            const deliveryFields = document.getElementById("deliveryFields");
            deliveryFields.style.display = (this.value === "Delivery") ? "block" : "none";
        });

        document.getElementById('makeOrder').addEventListener('click', () => {
            const orderType = document.getElementById('orderType').value;
            if (!orderType) {
                alert("من فضلك اختر نوع الطلب أولاً!");
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/UserOrder/Checkout';

            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = 'orderType';
            typeInput.value = orderType;
            form.appendChild(typeInput);

            if (orderType === 'Delivery') {
                const address = document.getElementById('deliveryAddress').value.trim();
                const phone = document.getElementById('phoneNumber').value.trim();

                if (!address || !phone) {
                    alert("من فضلك أدخل العنوان ورقم الهاتف لطلبات التوصيل!");
                    return;
                }

                const addressInput = document.createElement('input');
                addressInput.type = 'hidden';
                addressInput.name = 'deliveryAddress';
                addressInput.value = address;
                form.appendChild(addressInput);

                const phoneInput = document.createElement('input');
                phoneInput.type = 'hidden';
                phoneInput.name = 'phoneNumber';
                phoneInput.value = phone;
                form.appendChild(phoneInput);
            }

            document.body.appendChild(form);
            form.submit();
        });
    </script>
}
